{"title":"Vue3 响应式原理","uid":"b491bd34f265533799a79211838a0e41","slug":"vue3-reactive","date":"2021-04-06T14:27:28.471Z","updated":"2021-04-06T14:53:18.660Z","comments":true,"path":"api/articles/vue3-reactive.json","keywords":null,"cover":"http://img-blog.csdnimg.cn/20200716163610402.jpg","content":"<h2 id=\"简单的实现-Vue3-响应式原理\"><a href=\"#简单的实现-Vue3-响应式原理\" class=\"headerlink\" title=\"简单的实现 Vue3 响应式原理\"></a>简单的实现 Vue3 响应式原理</h2><span id=\"more\"></span>\n\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">let</span> toProxy = <span class=\"keyword\">new</span> <span class=\"built_in\">WeakMap</span>(); <span class=\"comment\">// 原对象：代理过得对象</span></span><br><span class=\"line\"><span class=\"keyword\">let</span> toRaw = <span class=\"keyword\">new</span> <span class=\"built_in\">WeakMap</span>(); <span class=\"comment\">// 被代理过得对象: 原对象</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">isObject</span>(<span class=\"params\">val</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">typeof</span> val === <span class=\"string\">&#x27;object&#x27;</span> &amp;&amp; val !== <span class=\"literal\">null</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">reactive</span>(<span class=\"params\">target</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> createReactiveObject(target);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">hasOwn</span>(<span class=\"params\">target, key</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> target.hasOwnProperty(key);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">let</span> proxy = reactive(&#123; <span class=\"attr\">name</span>: <span class=\"string\">&#x27;zf&#x27;</span> &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">createReactiveObject</span>(<span class=\"params\">target</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (!isObject(target)) <span class=\"keyword\">return</span> target;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// 处理多次代理的操作</span></span><br><span class=\"line\">  <span class=\"keyword\">let</span> proxy = toProxy.get(target);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (proxy) <span class=\"keyword\">return</span> proxy;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (toRaw.has(target)) <span class=\"keyword\">return</span> target;</span><br><span class=\"line\">  <span class=\"keyword\">let</span> baseHandler = &#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"title\">get</span>(<span class=\"params\">target, key, receiver</span>)</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">let</span> res = <span class=\"built_in\">Reflect</span>.get(target, key, receiver);</span><br><span class=\"line\">      <span class=\"comment\">// 实现多层代理</span></span><br><span class=\"line\"></span><br><span class=\"line\">      track(target, key);</span><br><span class=\"line\">      <span class=\"keyword\">return</span> isObject(res) ? reactive(res) : res;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"function\"><span class=\"title\">set</span>(<span class=\"params\">target, key, value, receiver</span>)</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">let</span> hadKey = hasOwn(target, key);</span><br><span class=\"line\">      <span class=\"keyword\">let</span> oldValue = target[key];</span><br><span class=\"line\">      <span class=\"keyword\">let</span> res = <span class=\"built_in\">Reflect</span>.set(target, key, value, receiver);</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (!hadKey) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 增加属性</span></span><br><span class=\"line\">        trigger(target, <span class=\"string\">&#x27;add&#x27;</span>, key);</span><br><span class=\"line\">      &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (oldValue !== value) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 修改属性 屏蔽没有意义的更新</span></span><br><span class=\"line\">        trigger(target, <span class=\"string\">&#x27;set&#x27;</span>, key);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> res;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"function\"><span class=\"title\">deleteProperty</span>(<span class=\"params\">target, key</span>)</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">let</span> res = <span class=\"built_in\">Reflect</span>.defineProperty(target, key);</span><br><span class=\"line\">      <span class=\"keyword\">return</span> res;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\">  <span class=\"keyword\">let</span> proxy = <span class=\"keyword\">new</span> <span class=\"built_in\">Proxy</span>(target, baseHandler);</span><br><span class=\"line\">  toProxy.set(target, proxy);</span><br><span class=\"line\">  toRaw.set(proxy, target);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> proxy;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 依赖收集 发布订阅</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">let</span> activeEffectStacks = [];</span><br><span class=\"line\"><span class=\"keyword\">let</span> targetsMap = <span class=\"keyword\">new</span> <span class=\"built_in\">WeakMap</span>();</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">track</span>(<span class=\"params\">target, key</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">let</span> effect = activeEffectStacks[activeEffectStacks.length - <span class=\"number\">1</span>];</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (effect) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">let</span> depMap = targetsMap.get(target);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!depMap) &#123;</span><br><span class=\"line\">      targetsMap.set(target, (depMap = <span class=\"keyword\">new</span> <span class=\"built_in\">Map</span>()));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">let</span> deps = depMap.get(key);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!deps) &#123;</span><br><span class=\"line\">      depMap, set(key, (deps = <span class=\"keyword\">new</span> <span class=\"built_in\">Set</span>()));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!deps.has(effect)) &#123;</span><br><span class=\"line\">      deps.add(effect);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">trigger</span>(<span class=\"params\">target, type, key</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">let</span> depsMap = targetsMap.get(target);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (depsMap) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">let</span> deps = depsMap.get(key);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (deps) &#123;</span><br><span class=\"line\">      deps.forEach(<span class=\"function\">(<span class=\"params\">effect</span>) =&gt;</span> &#123;</span><br><span class=\"line\">        effect();</span><br><span class=\"line\">      &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">effect</span>(<span class=\"params\">fn</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"comment\">// fn是响应的</span></span><br><span class=\"line\">  <span class=\"keyword\">let</span> effect = createReactiveEffect(fn);</span><br><span class=\"line\">  effect();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">createReactiveEffect</span>(<span class=\"params\">fn</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">let</span> effect = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> run(effect, fn);</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> effect;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">run</span>(<span class=\"params\">effect, fn</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">    activeEffectStacks.push(effect);</span><br><span class=\"line\">    fn();</span><br><span class=\"line\">  &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">    activeEffectStacks.pop();</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n","feature":null,"text":"简单的实现 Vue3 响应式原理 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566...","link":"","photos":[],"count_time":{"symbolsCount":"2.8k","symbolsTime":"3 mins."},"categories":[{"name":"vue","slug":"vue","count":2,"path":"api/categories/vue.json"}],"tags":[{"name":"vue3","slug":"vue3","count":1,"path":"api/tags/vue3.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E7%AE%80%E5%8D%95%E7%9A%84%E5%AE%9E%E7%8E%B0-Vue3-%E5%93%8D%E5%BA%94%E5%BC%8F%E5%8E%9F%E7%90%86\"><span class=\"toc-text\">简单的实现 Vue3 响应式原理</span></a></li></ol>","author":{"name":"麦当","avatar":"http://image.vulpix.top/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20210326214030.jpg","link":""},"mapped":true,"prev_post":{"title":"Vuex 源码分析","uid":"d99453202fb96ed4663408801fbf0008","slug":"vuex","date":"2021-04-06T14:27:28.497Z","updated":"2021-04-06T14:53:15.200Z","comments":true,"path":"api/articles/vuex.json","keywords":null,"cover":"http://img-blog.csdnimg.cn/20200716163610402.jpg","text":"vuex 简易实现 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697...","link":"","photos":[],"count_time":{"symbolsCount":"2.4k","symbolsTime":"2 mins."},"categories":[{"name":"vue","slug":"vue","count":2,"path":"api/categories/vue.json"}],"tags":[{"name":"vuex","slug":"vuex","count":1,"path":"api/tags/vuex.json"},{"name":"vue","slug":"vue","count":1,"path":"api/tags/vue.json"}],"author":{"name":"麦当","avatar":"http://image.vulpix.top/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20210326214030.jpg","link":""}},"next_post":{"title":"dataFetchHook","uid":"eb7ed51aa22769817771964a330ff0d5","slug":"useFetchData","date":"2021-04-06T14:27:28.438Z","updated":"2021-04-06T14:53:18.660Z","comments":true,"path":"api/articles/useFetchData.json","keywords":null,"cover":"http://img-blog.csdnimg.cn/20200716163610402.jpg","text":"Encapsulating data request with hook 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556...","link":"","photos":[],"count_time":{"symbolsCount":"4k","symbolsTime":"4 mins."},"categories":[{"name":"React","slug":"React","count":7,"path":"api/categories/React.json"}],"tags":[{"name":"React","slug":"React","count":7,"path":"api/tags/React.json"}],"author":{"name":"麦当","avatar":"http://image.vulpix.top/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20210326214030.jpg","link":""}}}